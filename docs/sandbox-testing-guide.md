# アプリ内課金サンドボックス環境テストガイド

## 概要

このドキュメントは、アプリをリリースせずにアプリ内課金をテストするためのサンドボックス環境の設定手順を説明します。App Store Connect (iOS) と Google Play Console (Android) の両方について解説します。

## 前提条件

- Apple Developer Program および Google Play Developer アカウントに登録済みであること。
- App Store Connect と Google Play Console にテスト対象のアプリが作成済みであること。
- `docs/revenuecat-setup-guide.md` に記載の手順に従い、各プラットフォームと RevenueCat でプロダクトが設定済みであること。

---

## 1. iOS (App Store Connect) でのサンドボックス設定

iOS のテストには、サンドックステストユーザーと TestFlight を利用します。

### 1.1 サンドックステストユーザーの作成

1.  **App Store Connect** にサインインします。
2.  「ユーザとアクセス」セクションに移動します。
3.  左側のメニューから「サンドボックス」>「テスター」を選択します。
4.  「+」ボタンをクリックして、新しいテストユーザーを作成します。
    - **注意**: ここで使用するメールアドレスは、既存の Apple ID であってはなりません。`youremail+testuser@gmail.com` のようなエイリアスを利用すると便利です。
5.  App Store の国/地域を選択し、アカウントを作成します。

### 1.2 TestFlight でのアプリ配布

1.  Xcode または EAS CLI を使用して、アプリのビルドを作成し、App Store Connect にアップロードします。
2.  App Store Connect で、対象アプリの「TestFlight」タブに移動します。
3.  「内部テスト」グループに、テストに使用する自分自身のアカウントを追加します。
4.  ビルドが処理された後、テスト担当者に招待メールが送信されます。

### 1.3 テストデバイスでの設定とテスト実行

1.  テストに使用する iPhone または iPad で、**既存の Apple ID を App Store からサインアウト**します。
    - `設定` > `[あなたの名前]` > `メディアと購入` > `サインアウト`
2.  TestFlight アプリ経由でテストビルドをインストールします。
3.  アプリを起動し、課金画面で商品を購入しようとすると、Apple ID でのサインインを求められます。
4.  ここで、**ステップ 1.1 で作成したサンドックステストユーザーの資格情報**を入力します。
5.  購入フローを進めます。価格表示に `[Environment: Sandbox]` と表示されていれば、正しくサンドボックス環境に接続されています。

---

## 2. Android (Google Play Console) でのサンドボックス設定

Android のテストには、ライセンステストユーザーと内部テストトラックを利用します。

### 2.1 ライセンステストユーザーの設定

1.  **Google Play Console** にサインインします。
2.  左側のメニューから `設定` > `ライセンステスト` を選択します。
3.  テストに使用する Google アカウント（Gmail アドレス）を追加します。
4.  「ライセンスのレスポンス」は `RESPOND_NORMALLY` のままにしておきます。

### 2.2 内部テストトラックへのアプリ配布

1.  Android Studio または EAS CLI を使用して、署名付きのアプリバンドル (AAB) または APK を作成します。
2.  Google Play Console で対象アプリを選択し、左側のメニューから `テスト` > `内部テスト` を選択します。
3.  新しいリリースを作成し、生成した AAB または APK をアップロードします。
4.  「テスター」タブに移動し、**ステップ 2.1 で追加したライセンステストユーザー**を含むメーリングリストを選択または作成します。
5.  画面下部に表示される**オプトイン URL** をコピーします。

### 2.3 テストデバイスでの設定とテスト実行

1.  テストに使用する Android デバイスで、**ライセンステストユーザーとして設定した Google アカウント**で Play ストアにログインしていることを確認します。
2.  デバイスのブラウザで、**ステップ 2.2 でコピーしたオプトイン URL** を開きます。
3.  「テストに参加」をタップし、指示に従って Play ストアからテスト版アプリをダウンロード・インストールします。
4.  アプリを起動し、課金画面で商品を購入します。
5.  購入ダイアログに「テストカード」が表示され、実際の請求が発生しないことが明記されていれば、正しくテスト環境に接続されています。

---

## 3. RevenueCat での確認

テスト購入が完了したら、RevenueCat のダッシュボードでデータが正しく反映されているか確認します。

1.  **RevenueCat ダッシュボード**にサインインします。
2.  画面右上の `View sandbox data` が有効になっていることを確認します。
3.  テストしたユーザーの顧客履歴を検索し、購入情報や `premium_access` Entitlement が付与されていることを確認します。

## 4. トラブルシューティング

- **プロダクトが読み込まれない**:
  - 各プラットフォームでのプロダクト設定（特にプロダクト ID）が `src/config/revenuecat.ts` と一致しているか確認してください。
  - Apple の場合、有料アプリ契約が有効になっているか確認してください。
- **テストユーザーでサインインできない**:
  - iOS: 既存の Apple ID が完全にサインアウトされているか確認してください。
  - Android: Play ストアにログインしているアカウントがライセンステスターとして登録されているか確認してください。
- **実際の課金が発生しそうになる**:
  - テスト環境の設定が間違っています。すぐに購入をキャンセルし、上記の手順を見直してください。
